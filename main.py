import discord
from discord.ext import commands
from difflib import SequenceMatcher

intents = discord.Intents.default()
intents.message_content = True
intents.guilds = True
intents.members = True
intents.bans = True
intents.guild_messages = True
intents.presences = True
intents.voice_states = True

bot = commands.Bot(command_prefix='!', intents=intents)
previous_channels = {}
spam_count = {}
whitelist = [] 


def similar(a, b):
    return SequenceMatcher(None, a, b).ratio()

log_channel_id = 1234567890
log_channel = None

def get_log_channel():
    global log_channel
    if log_channel is None:
        log_channel = bot.get_channel(log_channel_id)
    return log_channel

@bot.event
async def on_member_ban(guild, user):
    channel = get_log_channel()
    if channel:
        async for entry in guild.audit_logs(limit=1, action=discord.AuditLogAction.ban):
            responsible_user = entry.user

            if responsible_user.id not in whitelist:
                embed = discord.Embed(
                    title=f"üõë –£—á–∞—Å—Ç–Ω–∏–∫ **{user}** –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω",
                    description=f"–ó–∞–±–∞–Ω–∏–ª: **{responsible_user}**",
                    color=discord.Color.red()
                )
                embed.add_field(name="–£—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç –≤ –≤–∞–π—Ç –ª–∏—Å—Ç–µ –∏ –æ–Ω –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω!", value="", inline=False)
                await guild.ban(user, reason="–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞")
                await channel.send(embed=embed)
            else:
                embed = discord.Embed(
                    title=f"üõ°Ô∏è –£—á–∞—Å—Ç–Ω–∏–∫ **{user}** –±—ã–ª –∫–∏–∫–Ω—É—Ç",
                    description=f"–ö–∏–∫–Ω—É–ª: **{responsible_user}**",
                    color=discord.Color.green()
                )
                await channel.send(embed=embed)


@bot.event
async def on_member_remove(member):
    channel = get_log_channel()
    if channel:
        async for entry in member.guild.audit_logs(limit=1, action=discord.AuditLogAction.kick):
            if entry.target.id == member.id:

                kicker = entry.user
                if kicker != bot.user:
                    try:
                        if kicker.id not in whitelist:
                            embed = discord.Embed(
                                title=f"üõë –£—á–∞—Å—Ç–Ω–∏–∫ **{member}** –±—ã–ª –∫–∏–∫–Ω—É—Ç",
                                description=f"–ö–∏–∫–Ω—É–ª: **{kicker}**",
                                color=discord.Color.red()
                            )
                            embed.add_field(name="–£—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç –≤ –≤–∞–π—Ç –ª–∏—Å—Ç–µ –∏ –æ–Ω –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω!", value="", inline=False)
                            await kicker.ban(reason="–ö–∏–∫–Ω—É–ª —É—á–∞—Å—Ç–Ω–∏–∫–∞, —á—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
                            await channel.send(embed=embed)
                        else:
                            embed = discord.Embed(
                                title=f"üõ°Ô∏è –£—á–∞—Å—Ç–Ω–∏–∫ **{member}** –±—ã–ª –∫–∏–∫–Ω—É—Ç",
                                description=f"–ö–∏–∫–Ω—É–ª: **{kicker}**",
                                color=discord.Color.green()
                            )
                            await channel.send(embed=embed)
                    except discord.Forbidden:
                        print(f"–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –±–∞–Ω–∞ {kicker}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞.")
                    except discord.HTTPException:
                        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–∞–Ω–∏—Ç—å {kicker}.")


@bot.event
async def on_guild_role_update(before, after):
    async for entry in after.guild.audit_logs(limit=1, action=discord.AuditLogAction.role_update):
        if entry.target.id == after.id:
            changer = entry.user


            permissions_changed = []
            for perm in discord.Permissions.VALID_FLAGS:
                before_perm = getattr(before.permissions, perm)
                after_perm = getattr(after.permissions, perm)
                if before_perm != after_perm:
                    change = f"{'‚úÖ' if after_perm else '‚ùå'} {perm}"
                    permissions_changed.append(change)

            if permissions_changed:
                if changer.id not in whitelist:
                    embed = discord.Embed(
                        title=f"üõë –†–æ–ª—å **{after.name}** –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞",
                        description=f"–ò–∑–º–µ–Ω–∏–ª: **{changer}**",
                        color=discord.Color.red()
                    )
                    embed.add_field(name="–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞:", value="\n".join(permissions_changed), inline=False)
                    embed.add_field(name="–£—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç –≤ –≤–∞–π—Ç –ª–∏—Å—Ç–µ –∏ –æ–Ω –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω!", value="", inline=False)
                    channel = get_log_channel()
                    await channel.send(embed=embed)
                    await changer.ban(reason="–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞!")
                else:
                    embed = discord.Embed(
                        title=f"üõ°Ô∏è –†–æ–ª—å **{after.name}** –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞",
                        description=f"–ò–∑–º–µ–Ω–∏–ª: **{changer}**",
                        color=discord.Color.green()
                    )
                    embed.add_field(name="–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞:", value="\n".join(permissions_changed), inline=False)

                    channel = get_log_channel()
                    await channel.send(embed=embed)
            break

@bot.event
async def on_guild_role_create(role):
    channel = get_log_channel()
    if channel:
        async for entry in role.guild.audit_logs(limit=1, action=discord.AuditLogAction.role_create):
            user = entry.user
            if user.guild_permissions.manage_roles:
                try:

                    if user.id not in whitelist:

                        embed = discord.Embed(
                            title=f"üõë –ë—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ä–æ–ª—å **{role}**",
                            description=f"–°–æ–∑–¥–∞–ª: **{user}**",
                            color=discord.Color.red()
                        )
                        embed.add_field(name="–£—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç –≤ –≤–∞–π—Ç –ª–∏—Å—Ç–µ –∏ –æ–Ω –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω!", value="", inline=False)
                        await channel.send(embed=embed)
                        await role.guild.ban(user, reason="–ó–∞–±–∞–Ω–µ–Ω –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏!")
                    else:
                        embed = discord.Embed(
                            title=f"üõ°Ô∏è –ë—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ä–æ–ª—å **{role}**",
                            description=f"–°–æ–∑–¥–∞–ª: **{user}**",
                            color=discord.Color.green()
                        )
                        await channel.send(embed=embed)

                except discord.Forbidden:
                    print("–£ –±–æ—Ç–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –±–∞–Ω–∞.")
                except discord.HTTPException as e:
                    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
@bot.event
async def on_guild_role_delete(role):
    channel = get_log_channel()
    if channel:
        async for entry in role.guild.audit_logs(limit=1, action=discord.AuditLogAction.role_delete):
            user = entry.user
            if user.guild_permissions.manage_roles:
                try:

                    if user.id not in whitelist:
                        await role.guild.ban(user, reason="–ó–∞–±–∞–Ω–µ–Ω –∑–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–∏!")
                        embed = discord.Embed(
                            title=f"üõë –ë—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ —Ä–æ–ª—å **{role}**",
                            description=f"–£–¥–∞–ª–∏–ª: **{user}**",
                            color=discord.Color.red()
                        )
                        embed.add_field(name="–£—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç –≤ –≤–∞–π—Ç –ª–∏—Å—Ç–µ –∏ –æ–Ω –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω!", value="", inline=False)
                        await channel.send(embed=embed)
                        await role.guild.ban(user, reason="–ó–∞–±–∞–Ω–µ–Ω –∑–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–∏!")
                    else:
                        embed = discord.Embed(
                            title=f"üõ°Ô∏è –ë—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ —Ä–æ–ª—å **{role}**",
                            description=f"–£–¥–∞–ª–∏–ª: **{user}**",
                            color=discord.Color.green()
                        )
                        await channel.send(embed=embed)
                except discord.Forbidden:
                    print("–£ –±–æ—Ç–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –±–∞–Ω–∞.")
                except discord.HTTPException as e:
                    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

@bot.event
async def on_member_update(before, after):
    channel = get_log_channel()
    added_roles = set(after.roles) - set(before.roles)
    for role in added_roles:
        if role.name and role.permissions.administrator:

            if channel:
                async for entry in after.guild.audit_logs(limit=1, action=discord.AuditLogAction.member_role_update):
                    if entry.target.id == after.id:
                        admin_issuer = entry.user
                        if admin_issuer.id not in whitelist:
                            embed = discord.Embed(
                                title=f"üõë –ë—ã–ª–∞ –≤—ã–¥–∞–Ω–∞ —Ä–æ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ **{role}** —É—á–∞—Å—Ç–Ω–∏–∫—É **{after}**",
                                description=f"–í—ã–¥–∞–ª: **{admin_issuer}**",
                                color=discord.Color.red()
                            )
                            embed.add_field(name="–£—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç –≤ –≤–∞–π—Ç –ª–∏—Å—Ç–µ –∏ –æ–Ω –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω!", value="",inline=False)
                            await channel.send(embed=embed)
                            await after.remove_roles(role)
                            await after.guild.ban(admin_issuer, reason="–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞")
                        else:
                            embed = discord.Embed(
                                title=f"üõ°Ô∏è –ë—ã–ª–∞ –≤—ã–¥–∞–Ω–∞ —Ä–æ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ **{role}** —É—á–∞—Å—Ç–Ω–∏–∫—É **{after}**",
                                description=f"–í—ã–¥–∞–ª: **{admin_issuer}**",
                                color=discord.Color.green()
                            )
                            await channel.send(embed=embed)

@bot.event
async def on_guild_channel_create(channel):
    channel1 = get_log_channel()
    if channel.guild:

        async for entry in channel.guild.audit_logs(limit=1, action=discord.AuditLogAction.channel_create):
            if entry.user.id not in whitelist:
                embed = discord.Embed(
                    title=f"üõë –ë—ã–ª —Å–æ–∑–¥–∞–Ω –∫–∞–Ω–∞–ª **{channel.name}**",
                    description=f"–°–æ–∑–¥–∞—Ç–µ–ª—å: **{entry.user}** ",
                    color=discord.Color.red()
                )
                embed.add_field(name="–£—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç –≤ –≤–∞–π—Ç-–ª–∏—Å—Ç–µ –∏ –æ–Ω –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω, –∞ –∫–∞–Ω–∞–ª —É–¥–∞–ª–µ–Ω!", value="", inline=False)
                await channel1.send(embed=embed)
                await channel.delete(reason="–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è")
                await entry.user.ban(reason="–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω–æ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞!")
            else:
                embed = discord.Embed(
                    title=f"üõ°Ô∏è –ë—ã–ª —Å–æ–∑–¥–∞–Ω –∫–∞–Ω–∞–ª **{channel.name}**",
                    description=f"–°–æ–∑–¥–∞—Ç–µ–ª—å: **{entry.user}** ",
                    color=discord.Color.green()
                )
                await channel1.send(embed=embed)
@bot.event
async def on_guild_channel_delete(channel):
    channel1 = get_log_channel()
    if channel.guild:
        async for entry in channel.guild.audit_logs(limit=1, action=discord.AuditLogAction.channel_delete):

            previous_channels[channel.id] = {
                'name': channel.name,
                'position': channel.position,
                'overwrites': channel.overwrites,
                'category_id': channel.category_id
            }

            if entry.user.id not in whitelist:
                embed = discord.Embed(
                    title=f"üõë –ë—ã–ª —É–¥–∞–ª–µ–Ω –∫–∞–Ω–∞–ª **{channel.name}**",
                    description=f"–£–¥–∞–ª–∏–ª: **{entry.user}**",
                    color=discord.Color.red()
                )
                embed.add_field(name="–£—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ—Ç –≤ –≤–∞–π—Ç-–ª–∏—Å—Ç–µ –∏ –æ–Ω –±—ã–ª –∑–∞–±–∞–Ω–µ–Ω!", value="", inline=False)
                await channel1.send(embed=embed)
                await restore_channel(channel.guild, previous_channels[channel.id])
                await entry.user.ban(reason="–£–¥–∞–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤")

            else:
                embed = discord.Embed(
                    title=f"üõ°Ô∏è –ë—ã–ª —É–¥–∞–ª–µ–Ω –∫–∞–Ω–∞–ª **{channel.name}**",
                    description=f"–£–¥–∞–ª–∏–ª: **{entry.user}**",
                    color=discord.Color.green()
                )
                await channel1.send(embed=embed)


async def restore_channel(guild, channel_data):
    try:
        category = guild.get_channel(channel_data['category_id']) if channel_data['category_id'] else None

        restored_channel = await guild.create_text_channel(
            name=channel_data['name'],
            position=channel_data['position'],
            overwrites=channel_data['overwrites'],
            category=category
        )
        print(
            f'–ö–∞–Ω–∞–ª {restored_channel.name} –±—ã–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é {category.name if category else "–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"}.')
    except discord.HTTPException as e:
        print(f'–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–Ω–∞–ª: {e}')



@bot.event
async def on_message(message):
    author_id = message.author
    author_id1 = message.author.id
    muted_role_name = "Zamu4en"

    channel = get_log_channel()
    muted_role = discord.utils.get(message.guild.roles, name=muted_role_name)


    if author_id1 in whitelist:
        return

    content = message.content.lower()
    banned_words = ["http", "https", ".com", ",com", ",gg", ".gg", ".ru", "ru", ".net", ",net", "gg/", "gg /", ".fun", ",fun"]


    for word in banned_words:
        if word in content:
            if message.author.guild_permissions.administrator:
                embed = discord.Embed(
                    title=f"üõ°Ô∏è **{author_id}** –±—ã–ª –∑–∞–º—É—á–µ–Ω –∑–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Å—ã–ª–æ–∫",
                    description=f"–°–æ–æ–±—â–µ–Ω–∏–µ: `{message.content}`",
                    color=discord.Color.red()
                )
                await channel.send(embed=embed)
                await message.author.ban(reason='–ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–π–¥–∞')
            else:

                if not muted_role:
                    muted_role = await message.guild.create_role(name=muted_role_name)
                    for ch in message.guild.channels:
                        await ch.set_permissions(muted_role, send_messages=False)

                await message.author.add_roles(muted_role)
                embed = discord.Embed(
                    title=f"üõ°Ô∏è **{author_id}** –±—ã–ª –∑–∞–º—É—á–µ–Ω –∑–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Å—ã–ª–æ–∫",
                    description=f"–°–æ–æ–±—â–µ–Ω–∏–µ: `{message.content}`",
                    color=discord.Color.red()
                )
                await channel.send(embed=embed)
            await message.delete()
            break

    if author_id1 not in whitelist:
        if author_id in spam_count:
            similarity = similar(message.content, spam_count[author_id]['last_message'])

            if similarity >= 0.75:
                spam_count[author_id]['count'] += 1
                if spam_count[author_id]['count'] > 2:
                    if message.author.guild_permissions.administrator:
                        embed = discord.Embed(
                            title=f"üõ°Ô∏è **{author_id}** –±—ã–ª –∑–∞–º—É—á–µ–Ω –∑–∞ —Å–ø–∞–º",
                            description=f"–°–æ–æ–±—â–µ–Ω–∏–µ: `{message.content}`",
                            color=discord.Color.red()
                        )
                        await channel.send(embed=embed)
                        await message.author.ban(reason='–ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–π–¥–∞')
                    else:
                        if not muted_role:
                            muted_role = await message.guild.create_role(name=muted_role_name)
                            for ch in message.guild.channels:
                                await ch.set_permissions(muted_role, send_messages=False)

                        await message.author.add_roles(muted_role)
                        embed = discord.Embed(
                            title=f"üõ°Ô∏è **{author_id}** –±—ã–ª –∑–∞–º—É—á–µ–Ω –∑–∞ —Å–ø–∞–º",
                            description=f"–°–æ–æ–±—â–µ–Ω–∏–µ: `{message.content}`",
                            color=discord.Color.red()
                        )
                        await channel.send(embed=embed)

                    async for hist_message in message.channel.history(limit=10):
                        if similar(hist_message.content, message.content) >= 0.75:
                            await hist_message.delete()

                    spam_count[author_id]['count'] = 0
            else:
                spam_count[author_id] = {'count': 1, 'last_message': message.content}
        else:
            spam_count[author_id] = {'count': 1, 'last_message': message.content}

        spam_count[author_id]['last_message'] = message.content

    await bot.process_commands(message)


bot.run('')
